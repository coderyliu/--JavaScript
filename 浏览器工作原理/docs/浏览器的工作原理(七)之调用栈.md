# 浏览器的工作原理(七)之为什么Javascript代码会出现栈溢出

​	我们就来明确下，哪些情况下代码才算是“一段”代码，才会在执行之前就进行编译并创建执行上下文。一般说来，有这么三种情况：

- 当 JavaScript 执行全局代码的时候，会编译全局代码并创建全局执行上下文，而且在整个页面的生存周期内，全局执行上下文只有一份。
- 当调用一个函数的时候，函数体内的代码会被编译，并创建函数执行上下文，一般情况下，函数执行结束之后，创建的函数执行上下文会被销毁。
- 当使用 eval 函数的时候，eval 的代码也会被编译，并创建执行上下文。

​	好了，又进一步理解了执行上下文，那本节我们就在这基础之上继续深入，一起聊聊调用栈。学习调用栈至少

有以下三点好处：可以帮助你了解 JavaScript 引擎背后的工作原理；让你有调试 JavaScript 代码的能力；帮助你

搞定面试，因为面试过程中，调用栈也是出境率非常高的题目。比如你在写 JavaScript 代码的时候，有时候可能

会遇到栈溢出的错误，如下图所示：

![image-20220503191650756](D:\截图\22_浏览器原理\image-20220503191650756.png)

​	那为什么会出现这种错误呢？这就涉及到了**调用栈**的内容。你应该知道 JavaScript 中有很多函数，经常会出现在一个函数中调用另外一个函数的情况，**调用栈就是用来管理函数调用关系的一种数据结构**。因此要讲清楚调用栈，你还要先弄明白函数调用和栈结构。

### **什么是函数调用**

​	函数调用就是运行一个函数，具体使用方式是使用函数名称跟着一对小括号。下面我们看个简单的示例代码：

```java
var a = 2
function add(){
var b = 10
return  a+b
}
add()
```

​	这段代码很简单，先是创建了一个 add 函数，接着在代码的最下面又调用了该函数。

​	那么下面我们就利用这段简单的代码来解释下函数调用的过程。在执行到函数 add() 之前，JavaScript 引擎会为上面这段代码创建全局执行上下文，包含了声明的函数和变量，你可以参考下图：

![image-20220503191917669](D:\截图\22_浏览器原理\image-20220503191917669.png)

​	执行上下文准备好之后，便开始执行全局代码，当执行到 add 这儿时，JavaScript 判断这是一个函数调用，那

么将执行以下操作：首先，从全局执行上下文中，取出 add 函数代码。其次，对 add 函数的这段代码进行编译，

并创建该函数的执行上下文和可执行代码。最后，执行代码，输出结果。完整流程你可以参考下图：

![image-20220503192111459](D:\截图\22_浏览器原理\image-20220503192111459.png)

###  栈溢出（Stack Overflow）

​	现在你知道了调用栈是一种用来管理执行上下文的数据结构，符合后进先出的规则。不过还有一点你要注意，调用栈是有大小的，当入栈的执行上下文超过一定数目，JavaScript 引擎就会报错，我们把这种错误叫做栈溢出。特别是在你写递归代码的时候，就很容易出现栈溢出的情况。比如下面这段代码：

```jsx
function division(a,b){
    return division(a,b)
}
console.log(division(1,2))
```

![image-20220503192257788](D:\截图\22_浏览器原理\image-20220503192257788.png)

​	从上图你可以看到，抛出的错误信息为：超过了最大栈调用大小（Maximum call stack size exceeded）。

​	那为什么会出现这个问题呢？

​	这是因为当 JavaScript 引擎开始执行这段代码时，它首先调用函数 division，并创建执行上下文，压入栈中；然

而，这个函数是递归的，并且没有任何终止条件，所以它会一直创建新的函数执行上下文，并反复将其压入栈中，

但栈是有容量限制的，超过最大数量后就会出现栈溢出的错误。理解了栈溢出原因后，你就可以使用一些方法来避

免或者解决栈溢出的问题，比如把递归调用的形式改造成其他形式，或者使用加入定时器的方法来把当前任务拆分

为其他很多小任务。